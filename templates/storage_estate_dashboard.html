{% extends "base.html" %}

{% block title %}Storage Estate Overview{% endblock %}

{% block content %}
<style>
    .estate-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 25px;
    }

    .overview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .overview-card {
        background: rgba(255, 255, 255, 0.2);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }

    .overview-card h3 {
        font-size: 36px;
        margin: 0 0 5px 0;
        color: white;
    }

    .overview-card p {
        margin: 0;
        font-size: 14px;
        opacity: 0.9;
    }

    .capacity-summary {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .capacity-bar {
        height: 40px;
        background: #e2e8f0;
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        margin: 15px 0;
    }

    .capacity-fill {
        height: 100%;
        background: linear-gradient(90deg, #48bb78 0%, #38a169 50%, #2f855a 100%);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .capacity-fill.warning {
        background: linear-gradient(90deg, #ed8936 0%, #dd6b20 100%);
    }

    .capacity-fill.critical {
        background: linear-gradient(90deg, #fc8181 0%, #f56565 100%);
    }

    .section {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e2e8f0;
    }

    .section-header h2 {
        margin: 0;
        color: #2d3748;
    }

    .library-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 15px;
    }

    .library-card {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s;
    }

    .library-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .library-card.cloud {
        border-left: 4px solid #4299e1;
        background: #ebf8ff;
    }

    .library-card.dedupe {
        border-left: 4px solid #9f7aea;
        background: #faf5ff;
    }

    .library-card.disk {
        border-left: 4px solid #48bb78;
        background: #f0fff4;
    }

    .library-card.offline {
        border-left: 4px solid #fc8181;
        background: #fff5f5;
    }

    .library-name {
        font-size: 16px;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 8px;
    }

    .library-type {
        font-size: 13px;
        color: #718096;
        margin-bottom: 10px;
    }

    .library-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 13px;
        color: #4a5568;
    }

    .stat-label {
        font-weight: 600;
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-right: 5px;
    }

    .badge-online {
        background: #c6f6d5;
        color: #22543d;
    }

    .badge-offline {
        background: #fed7d7;
        color: #742a2a;
    }

    .badge-cloud {
        background: #bee3f8;
        color: #2c5282;
    }

    .badge-dedupe {
        background: #e9d8fd;
        color: #44337a;
    }

    .table-container {
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .data-table thead {
        background: #f7fafc;
    }

    .data-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #2d3748;
        border-bottom: 2px solid #e2e8f0;
    }

    .data-table td {
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
        color: #4a5568;
    }

    .data-table tbody tr:hover {
        background: #f7fafc;
    }

    .usage-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
    }

    .usage-good {
        background: #48bb78;
    }

    .usage-warning {
        background: #ed8936;
    }

    .usage-critical {
        background: #fc8181;
    }

    .info-banner {
        background: #bee3f8;
        border-left: 4px solid #4299e1;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .warning-banner {
        background: #feebc8;
        border-left: 4px solid #ed8936;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .tab-container {
        margin-top: 20px;
    }

    .tab-buttons {
        display: flex;
        gap: 5px;
        border-bottom: 2px solid #e2e8f0;
        margin-bottom: 20px;
    }

    .tab-button {
        padding: 12px 24px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #718096;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
    }

    .tab-button:hover {
        color: #4299e1;
    }

    .tab-button.active {
        color: #4299e1;
        border-bottom-color: #4299e1;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .write-pattern-card {
        background: #f7fafc;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .write-pattern-flow {
        display: flex;
        align-items: center;
        gap: 15px;
        margin: 10px 0;
        font-size: 14px;
    }

    .flow-arrow {
        color: #667eea;
        font-size: 20px;
    }
</style>

<div class="nav-links">
    <a href="{{ url_for('index') }}">Home</a>
    <a href="{{ url_for('infrastructure_dashboard') }}">Dashboard</a>
    <a href="{{ url_for('storage_estate_dashboard') }}" style="background: #f0f0f0;">Storage Estate</a>
    <a href="{{ url_for('view_data', data_type='storage_pools') }}">Storage Pools</a>
</div>

<div class="estate-header">
    <h1 style="margin: 0 0 5px 0;">Storage Estate Overview</h1>
    <p style="margin: 0; opacity: 0.9;">Complete view of all storage libraries, pools, and write patterns</p>

    <div class="overview-grid">
        <div class="overview-card">
            <h3>{{ overview.total_libraries }}</h3>
            <p>Total Libraries</p>
        </div>
        <div class="overview-card">
            <h3>{{ overview.total_pools }}</h3>
            <p>Storage Pools</p>
        </div>
        <div class="overview-card">
            <h3>{{ "%.2f"|format(overview.total_capacity_tb) }}</h3>
            <p>Total Capacity (TB)</p>
        </div>
        <div class="overview-card">
            <h3>{{ "%.1f"|format(overview.overall_used_pct) }}%</h3>
            <p>Overall Utilization</p>
        </div>
        <div class="overview-card">
            <h3>{{ overview.plans_writing_to_storage }}</h3>
            <p>Active Plans</p>
        </div>
    </div>
</div>

<!-- Quick Health Summary -->
<div class="capacity-summary">
    <h2 style="margin: 0 0 15px 0; color: #2d3748;">Estate Capacity Summary</h2>

    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 15px;">
        <div>
            <div style="font-size: 13px; color: #718096; margin-bottom: 5px;">Total Capacity</div>
            <div style="font-size: 24px; font-weight: bold; color: #2d3748;">{{ "%.2f"|format(overview.total_capacity_tb) }} TB</div>
        </div>
        <div>
            <div style="font-size: 13px; color: #718096; margin-bottom: 5px;">Used Space</div>
            <div style="font-size: 24px; font-weight: bold; color: #f56565;">{{ "%.2f"|format(overview.total_used_tb) }} TB</div>
        </div>
        <div>
            <div style="font-size: 13px; color: #718096; margin-bottom: 5px;">Free Space</div>
            <div style="font-size: 24px; font-weight: bold; color: #48bb78;">{{ "%.2f"|format(overview.total_free_tb) }} TB</div>
        </div>
    </div>

    <div class="capacity-bar">
        <div class="capacity-fill {% if overview.overall_used_pct > 90 %}critical{% elif overview.overall_used_pct > 75 %}warning{% endif %}"
             style="width: {{ overview.overall_used_pct }}%">
            {{ "%.1f"|format(overview.overall_used_pct) }}% Used
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; font-size: 13px; color: #718096; margin-top: 5px;">
        <div>0%</div>
        <div>50%</div>
        <div>100%</div>
    </div>
</div>

{% if overview.critical_pools > 0 %}
<div class="warning-banner">
    <strong style="color: #c05621;">Warning:</strong> {{ overview.critical_pools }} storage pool(s) are above 80% capacity. Review the Storage Pools tab for details.
</div>
{% endif %}

<!-- Tabs for different views -->
<div class="tab-container">
    <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('libraries')">Libraries ({{ overview.total_libraries }})</button>
        <button class="tab-button" onclick="switchTab('pools')">Storage Pools ({{ overview.total_pools }})</button>
        <button class="tab-button" onclick="switchTab('writepatterns')">Write Patterns ({{ overview.plans_writing_to_storage }})</button>
        <button class="tab-button" onclick="switchTab('summary')">Summary by Type</button>
    </div>

    <!-- Libraries Tab -->
    <div id="tab-libraries" class="tab-content active">
        <div class="section">
            <div class="section-header">
                <h2>Storage Libraries</h2>
                <div>
                    <span class="badge badge-online">{{ overview.online_libraries }} Online</span>
                    {% if overview.offline_libraries > 0 %}
                    <span class="badge badge-offline">{{ overview.offline_libraries }} Offline</span>
                    {% endif %}
                </div>
            </div>

            {% if libraries %}
            <div class="library-grid">
                {% for lib in libraries %}
                <div class="library-card {% if lib.isCloudStorage %}cloud{% elif lib.isDedupe %}dedupe{% elif lib.libraryTypeDesc == 'Disk Library' %}disk{% endif %} {% if lib.status != 'Online' %}offline{% endif %}">
                    <div class="library-name">{{ lib.libraryName }}</div>
                    <div class="library-type">
                        {{ lib.libraryTypeDesc or 'Unknown Type' }}
                        {% if lib.isCloudStorage %}<span class="badge badge-cloud">Cloud</span>{% endif %}
                        {% if lib.isDedupe %}<span class="badge badge-dedupe">Dedupe</span>{% endif %}
                    </div>

                    <div class="library-stats">
                        <div><span class="stat-label">Status:</span></div>
                        <div>
                            <span class="badge {% if lib.status == 'Online' %}badge-online{% else %}badge-offline{% endif %}">
                                {{ lib.status or 'Unknown' }}
                            </span>
                        </div>

                        {% if lib.capacity %}
                        <div><span class="stat-label">Capacity:</span></div>
                        <div>{{ "%.2f"|format(lib.capacity / (1024**4)) }} TB</div>

                        <div><span class="stat-label">Free:</span></div>
                        <div>{{ "%.2f"|format(lib.freeSpace / (1024**4)) }} TB</div>

                        <div><span class="stat-label">Used:</span></div>
                        <div>
                            <span class="usage-indicator {% if lib.usedPercent > 90 %}usage-critical{% elif lib.usedPercent > 75 %}usage-warning{% else %}usage-good{% endif %}"></span>
                            {{ "%.1f"|format(lib.usedPercent) }}%
                        </div>
                        {% endif %}

                        {% if lib.mediaAgentName %}
                        <div><span class="stat-label">MediaAgent:</span></div>
                        <div>{{ lib.mediaAgentName }}</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="info-banner">
                No library data available. Run the fetch_storage_estate.py script to collect library information.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Storage Pools Tab -->
    <div id="tab-pools" class="tab-content">
        <div class="section">
            <div class="section-header">
                <h2>Storage Pools</h2>
                <div style="font-size: 14px; color: #718096;">
                    Total: {{ overview.total_pools }} pools | In Use: {{ overview.pools_in_use }}
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Pool Name</th>
                            <th>Type</th>
                            <th>MediaAgent</th>
                            <th>Capacity</th>
                            <th>Used</th>
                            <th>Dedupe</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pool in pools[:50] %}
                        <tr>
                            <td>
                                <strong>{{ pool.storagePoolName }}</strong>
                                {% if pool.storagePoolId in pool_library_map %}
                                <br><span style="font-size: 12px; color: #718096;">→ {{ pool_library_map[pool.storagePoolId].libraryName }}</span>
                                {% endif %}
                            </td>
                            <td>{{ pool.storagePoolType or 'N/A' }}</td>
                            <td>{{ pool.mediaAgentName or 'N/A' }}</td>
                            <td>
                                {% if pool.totalCapacity > 0 %}
                                    {{ "%.2f"|format(pool.totalCapacity / (1024**3)) }} GB
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if pool.totalCapacity > 0 %}
                                    <span class="usage-indicator {% if pool.usedPercent > 90 %}usage-critical{% elif pool.usedPercent > 75 %}usage-warning{% else %}usage-good{% endif %}"></span>
                                    {{ "%.1f"|format(pool.usedPercent) }}%
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>{{ 'Yes' if pool.dedupeEnabled == '1' else 'No' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if pools|length > 50 %}
            <p style="margin-top: 15px; color: #718096; font-size: 13px;">Showing first 50 of {{ pools|length }} pools</p>
            {% endif %}
        </div>
    </div>

    <!-- Write Patterns Tab -->
    <div id="tab-writepatterns" class="tab-content">
        <div class="section">
            <div class="section-header">
                <h2>Storage Write Patterns</h2>
                <div style="font-size: 14px; color: #718096;">
                    What data writes to which storage
                </div>
            </div>

            {% if write_patterns %}
            <div style="max-height: 600px; overflow-y: auto;">
                {% for pattern in write_patterns[:30] %}
                <div class="write-pattern-card">
                    <div style="font-weight: bold; color: #2d3748; margin-bottom: 10px;">
                        {{ pattern.planName or 'Unknown Plan' }}
                    </div>

                    <div class="write-pattern-flow">
                        <div style="background: #ebf8ff; padding: 8px 15px; border-radius: 4px;">
                            Plan ID: {{ pattern.planId }}
                        </div>
                        <div class="flow-arrow">→</div>
                        <div style="background: #f0fff4; padding: 8px 15px; border-radius: 4px;">
                            Pool: {{ pattern.storagePoolName or 'Unknown' }}
                        </div>
                        {% if pattern.libraryName %}
                        <div class="flow-arrow">→</div>
                        <div style="background: #faf5ff; padding: 8px 15px; border-radius: 4px;">
                            Library: {{ pattern.libraryName }}
                        </div>
                        {% endif %}
                    </div>

                    {% if pattern.retentionDays %}
                    <div style="font-size: 13px; color: #718096; margin-top: 8px;">
                        Retention: {{ pattern.retentionDays }} days
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            {% if write_patterns|length > 30 %}
            <p style="margin-top: 15px; color: #718096; font-size: 13px;">Showing first 30 of {{ write_patterns|length }} patterns</p>
            {% endif %}

            {% else %}
            <div class="info-banner">
                No write pattern data available. Run the fetch_storage_estate.py script to analyze storage usage patterns.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Summary by Type Tab -->
    <div id="tab-summary" class="tab-content">
        <div class="section">
            <div class="section-header">
                <h2>Libraries by Type</h2>
            </div>

            {% for lib_type, libs in libraries_by_type.items() %}
            <div style="margin-bottom: 30px;">
                <h3 style="color: #2d3748; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 15px;">
                    {{ lib_type }} ({{ libs|length }})
                </h3>

                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                    {% for lib in libs %}
                    <div style="background: #f7fafc; border-radius: 6px; padding: 15px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; margin-bottom: 5px;">{{ lib.libraryName }}</div>
                        <div style="font-size: 13px; color: #718096;">
                            {% if lib.capacity %}
                            {{ "%.2f"|format(lib.capacity / (1024**4)) }} TB | {{ "%.1f"|format(lib.usedPercent) }}% used
                            {% else %}
                            Capacity data unavailable
                            {% endif %}
                        </div>
                        <div style="font-size: 12px; color: #718096; margin-top: 5px;">
                            {{ lib.status or 'Unknown Status' }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function switchTab(tabName) {
    // Hide all tabs
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.classList.remove('active'));

    // Deactivate all buttons
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(button => button.classList.remove('active'));

    // Show selected tab
    document.getElementById('tab-' + tabName).classList.add('active');

    // Activate clicked button
    event.target.classList.add('active');
}
</script>

{% endblock %}
