{% extends "base.html" %}

{% block title %}Retention Health Dashboard{% endblock %}

{% block content %}
<div class="nav-links">
    <a href="{{ url_for('index') }}">Home</a>
    <a href="{{ url_for('infrastructure_dashboard') }}">üèóÔ∏è Infrastructure Dashboard</a>
    <a href="{{ url_for('retention_health_dashboard') }}" style="background: #f0f0f0;">üíä Retention Health</a>
    <a href="{{ url_for('storage_pool_health_dashboard') }}">üóÑÔ∏è Storage Pool Health</a>
    <a href="{{ url_for('view_retention_policies') }}">üìã Retention Policies</a>
</div>

<h2 style="margin-bottom: 20px; color: #333;">Retention Health Dashboard</h2>

<!-- Summary Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <!-- Total Rules -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Retention Rules</div>
        <div style="font-size: 36px; font-weight: bold;">{{ stats.total_rules }}</div>
    </div>

    <!-- Optimal -->
    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">‚úÖ Optimal Config</div>
        <div style="font-size: 36px; font-weight: bold;">{{ stats.optimal }}</div>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">{{ stats.optimal_pct }}%</div>
    </div>

    <!-- Critical Issues -->
    <div style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); padding: 20px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üî¥ Aging Disabled</div>
        <div style="font-size: 36px; font-weight: bold;">{{ stats.aging_disabled }}</div>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">{{ stats.aging_disabled_pct }}% - CRITICAL</div>
    </div>

    <!-- High Priority -->
    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üü† Inefficient Short-Term</div>
        <div style="font-size: 36px; font-weight: bold;">{{ stats.inefficient_short_term }}</div>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">{{ stats.inefficient_short_term_pct }}% - HIGH PRIORITY</div>
    </div>

    <!-- Medium Priority -->
    <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 20px; border-radius: 8px; color: #333; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üü° High Cycles</div>
        <div style="font-size: 36px; font-weight: bold;">{{ stats.high_cycles }}</div>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">{{ stats.high_cycles_pct }}% - MEDIUM</div>
    </div>

    <!-- Info -->
    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 8px; color: #333; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üîµ Infinite Retention</div>
        <div style="font-size: 36px; font-weight: bold;">{{ stats.infinite_retention }}</div>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">{{ stats.infinite_retention_pct }}% - INFO</div>
    </div>
</div>

<!-- Issue Severity Breakdown Chart -->
<div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 20px;">
        Issue Severity Breakdown
    </h3>

    <div style="display: flex; align-items: center; gap: 30px;">
        <!-- Visual Bar Chart -->
        <div style="flex: 1;">
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 600; color: #dc3545;">üî¥ Aging Disabled (CRITICAL)</span>
                    <span>{{ stats.aging_disabled }} ({{ stats.aging_disabled_pct }}%)</span>
                </div>
                <div style="background: #f0f0f0; height: 25px; border-radius: 4px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #eb3349 0%, #f45c43 100%); height: 100%; width: {{ stats.aging_disabled_pct }}%; transition: width 0.5s;"></div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 600; color: #ff6b6b;">üü† Inefficient Short-Term (HIGH)</span>
                    <span>{{ stats.inefficient_short_term }} ({{ stats.inefficient_short_term_pct }}%)</span>
                </div>
                <div style="background: #f0f0f0; height: 25px; border-radius: 4px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%); height: 100%; width: {{ stats.inefficient_short_term_pct }}%; transition: width 0.5s;"></div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 600; color: #ffa500;">üü° High Cycles (MEDIUM)</span>
                    <span>{{ stats.high_cycles }} ({{ stats.high_cycles_pct }}%)</span>
                </div>
                <div style="background: #f0f0f0; height: 25px; border-radius: 4px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #ffecd2 0%, #fcb69f 100%); height: 100%; width: {{ stats.high_cycles_pct }}%; transition: width 0.5s;"></div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 600; color: #17a2b8;">üîµ Infinite Retention (INFO)</span>
                    <span>{{ stats.infinite_retention }} ({{ stats.infinite_retention_pct }}%)</span>
                </div>
                <div style="background: #f0f0f0; height: 25px; border-radius: 4px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%); height: 100%; width: {{ stats.infinite_retention_pct }}%; transition: width 0.5s;"></div>
                </div>
            </div>

            <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 600; color: #28a745;">üü¢ Optimal (OK)</span>
                    <span>{{ stats.optimal }} ({{ stats.optimal_pct }}%)</span>
                </div>
                <div style="background: #f0f0f0; height: 25px; border-radius: 4px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%); height: 100%; width: {{ stats.optimal_pct }}%; transition: width 0.5s;"></div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div style="min-width: 250px;">
            <h4 style="margin-bottom: 15px;">Retention Health Score</h4>
            {% set health_score = stats.optimal_pct %}
            <div style="text-align: center;">
                <div style="font-size: 48px; font-weight: bold;
                    {% if health_score >= 90 %}color: #28a745;
                    {% elif health_score >= 70 %}color: #ffc107;
                    {% elif health_score >= 50 %}color: #ff6b6b;
                    {% else %}color: #dc3545;{% endif %}">
                    {{ health_score|round(1) }}%
                </div>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    {% if health_score >= 90 %}‚úÖ Excellent
                    {% elif health_score >= 70 %}‚ö†Ô∏è Good
                    {% elif health_score >= 50 %}üî∂ Fair
                    {% else %}üî¥ Poor{% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Top Problem Plans -->
{% if top_problem_plans %}
<div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 20px;">
        Top 20 Plans with Issues
    </h3>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Plan Name</th>
                    <th>Issue Count</th>
                    <th>Aging Disabled</th>
                    <th>Infinite Retention</th>
                    <th>High Cycles</th>
                    <th>Inefficient Short-Term</th>
                </tr>
            </thead>
            <tbody>
                {% for plan_name, issues in top_problem_plans %}
                <tr>
                    <td><strong>{{ plan_name }}</strong></td>
                    <td style="text-align: center;">
                        <span style="background: #dc3545; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;">
                            {{ issues.issue_count }}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        {% if issues.aging_disabled %}
                            <span style="color: #dc3545; font-weight: 600;">üî¥ YES</span>
                        {% else %}
                            <span style="color: #28a745;">‚úì</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% if issues.infinite_retention %}
                            <span style="color: #17a2b8; font-weight: 600;">üîµ YES</span>
                        {% else %}
                            <span style="color: #28a745;">‚úì</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% if issues.high_cycles %}
                            <span style="color: #ffa500; font-weight: 600;">üü° YES</span>
                        {% else %}
                            <span style="color: #28a745;">‚úì</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% if issues.inefficient_short_term %}
                            <span style="color: #ff6b6b; font-weight: 600;">üü† YES</span>
                        {% else %}
                            <span style="color: #28a745;">‚úì</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Issue Details -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">

    <!-- Aging Disabled Rules -->
    {% if aging_disabled_rules %}
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #dc3545;">
        <h4 style="color: #dc3545; margin-bottom: 15px;">üî¥ Aging Disabled (Critical)</h4>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            Data will NEVER age - 0% space reclamation
        </p>
        <div style="max-height: 200px; overflow-y: auto;">
            {% for rule in aging_disabled_rules %}
            <div style="padding: 8px; margin-bottom: 8px; background: #fff5f5; border-radius: 4px;">
                <div style="font-weight: 600;">{{ rule.parentName }}</div>
                <div style="font-size: 13px; color: #666;">Copy: {{ rule.entityName }}</div>
            </div>
            {% endfor %}
        </div>
        {% if stats.aging_disabled > 10 %}
        <div style="margin-top: 10px; font-size: 13px; color: #666;">
            ... and {{ stats.aging_disabled - 10 }} more rules
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Inefficient Short-Term Rules -->
    {% if inefficient_short_rules %}
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #ff6b6b;">
        <h4 style="color: #ff6b6b; margin-bottom: 15px;">üü† Inefficient Short-Term (High Priority)</h4>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            ‚â§30 days + 2 cycles = 7-14 day aging delay
        </p>
        <div style="max-height: 200px; overflow-y: auto;">
            {% for rule in inefficient_short_rules %}
            <div style="padding: 8px; margin-bottom: 8px; background: #fff5f5; border-radius: 4px;">
                <div style="font-weight: 600;">{{ rule.parentName }}</div>
                <div style="font-size: 13px; color: #666;">
                    Copy: {{ rule.entityName }} |
                    {{ rule.retainBackupDataForDays }}d + {{ rule.retainBackupDataForCycles }}c
                </div>
            </div>
            {% endfor %}
        </div>
        {% if stats.inefficient_short_term > 10 %}
        <div style="margin-top: 10px; font-size: 13px; color: #666;">
            ... and {{ stats.inefficient_short_term - 10 }} more rules
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- High Cycle Rules -->
    {% if high_cycle_rules %}
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #ffa500;">
        <h4 style="color: #ffa500; margin-bottom: 15px;">üü° High Cycles (Medium Priority)</h4>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            3+ cycles = Very slow aging
        </p>
        <div style="max-height: 200px; overflow-y: auto;">
            {% for rule in high_cycle_rules %}
            <div style="padding: 8px; margin-bottom: 8px; background: #fffbf0; border-radius: 4px;">
                <div style="font-weight: 600;">{{ rule.parentName }}</div>
                <div style="font-size: 13px; color: #666;">
                    Copy: {{ rule.entityName }} |
                    {{ rule.retainBackupDataForDays }}d + {{ rule.retainBackupDataForCycles }}c
                </div>
            </div>
            {% endfor %}
        </div>
        {% if stats.high_cycles > 10 %}
        <div style="margin-top: 10px; font-size: 13px; color: #666;">
            ... and {{ stats.high_cycles - 10 }} more rules
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Infinite Retention Rules -->
    {% if infinite_retention_rules %}
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #17a2b8;">
        <h4 style="color: #17a2b8; margin-bottom: 15px;">üîµ Infinite Retention (Info)</h4>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            May be intentional for compliance/legal hold
        </p>
        <div style="max-height: 200px; overflow-y: auto;">
            {% for rule in infinite_retention_rules %}
            <div style="padding: 8px; margin-bottom: 8px; background: #e7f7ff; border-radius: 4px;">
                <div style="font-weight: 600;">{{ rule.parentName }}</div>
                <div style="font-size: 13px; color: #666;">Copy: {{ rule.entityName }}</div>
            </div>
            {% endfor %}
        </div>
        {% if stats.infinite_retention > 10 %}
        <div style="margin-top: 10px; font-size: 13px; color: #666;">
            ... and {{ stats.infinite_retention - 10 }} more rules
        </div>
        {% endif %}
    </div>
    {% endif %}

</div>

<!-- Recommendations -->
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: white;">
    <h3 style="color: white; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px; margin-bottom: 20px;">
        üí° Immediate Actions Recommended
    </h3>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        {% if stats.aging_disabled > 0 %}
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px;">
            <div style="font-weight: 600; margin-bottom: 8px;">1. Enable Aging (CRITICAL)</div>
            <div style="font-size: 14px; opacity: 0.9;">
                {{ stats.aging_disabled }} rules have aging disabled.<br>
                Impact: 0% space reclamation until fixed.
            </div>
        </div>
        {% endif %}

        {% if stats.inefficient_short_term > 0 %}
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px;">
            <div style="font-weight: 600; margin-bottom: 8px;">2. Reduce Cycle Requirements (HIGH)</div>
            <div style="font-size: 14px; opacity: 0.9;">
                {{ stats.inefficient_short_term }} rules have inefficient cycles.<br>
                Recommendation: 2 cycles ‚Üí 1 cycle for ‚â§30 day policies.
            </div>
        </div>
        {% endif %}

        {% if stats.high_cycles > 0 %}
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px;">
            <div style="font-weight: 600; margin-bottom: 8px;">3. Review High Cycle Rules (MEDIUM)</div>
            <div style="font-size: 14px; opacity: 0.9;">
                {{ stats.high_cycles }} rules require 3+ cycles.<br>
                Consider reducing to 2 cycles maximum.
            </div>
        </div>
        {% endif %}

        {% if stats.infinite_retention > 0 %}
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px;">
            <div style="font-weight: 600; margin-bottom: 8px;">4. Review Infinite Retention (INFO)</div>
            <div style="font-size: 14px; opacity: 0.9;">
                {{ stats.infinite_retention }} rules have infinite retention.<br>
                Confirm if actually required for compliance.
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}
