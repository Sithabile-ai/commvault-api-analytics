{% extends "base.html" %}

{% block title %}Storage Pool Health Dashboard{% endblock %}

{% block content %}
<div class="nav-links">
    <a href="{{ url_for('index') }}">Home</a>
    <a href="{{ url_for('infrastructure_dashboard') }}">üèóÔ∏è Infrastructure Dashboard</a>
    <a href="{{ url_for('retention_health_dashboard') }}">üíä Retention Health</a>
    <a href="{{ url_for('storage_pool_health_dashboard') }}" style="background: #f0f0f0;">üóÑÔ∏è Storage Pool Health</a>
    <a href="{{ url_for('view_retention_policies') }}">üìã Retention Policies</a>
</div>

<h2 style="margin-bottom: 20px; color: #333;">üóÑÔ∏è Storage Pool Health Dashboard</h2>

{% if stats.total_capacity_tb == 0 %}
<!-- No Data Warning -->
<div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
    <h3 style="color: #856404; margin: 0 0 10px 0;">‚ö†Ô∏è No Storage Pool Data Available</h3>
    <p style="color: #856404; margin: 0; line-height: 1.6;">
        No storage pool capacity data has been fetched from Commvault yet. Please go to the
        <a href="{{ url_for('index') }}" style="color: #667eea; font-weight: 600;">home page</a>
        and select "Storage Pools" to retrieve data from your CommCell.
    </p>
</div>
{% else %}
<div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
    <p style="color: #1976D2; font-weight: 600; margin: 0;">
        Analyzing {{ stats.total_pools }} storage pools to identify capacity issues and pruning failures
    </p>
</div>
{% endif %}

<!-- Summary Statistics Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <!-- Total Pools -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Storage Pools</div>
        <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;">{{ stats.total_pools }}</div>
        <div style="font-size: 12px; opacity: 0.8;">
            {{ stats.dedup_pools }} dedup / {{ stats.non_dedup_pools }} non-dedup
        </div>
    </div>

    <!-- Critical Pools -->
    <div style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); padding: 20px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üî¥ Critical (<10% Free)</div>
        <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;">{{ stats.critical }}</div>
        <div style="font-size: 12px; opacity: 0.8;">
            {{ stats.critical_pct }}% of pools - URGENT ACTION
        </div>
    </div>

    <!-- Warning Pools -->
    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üü† Warning (10-20% Free)</div>
        <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;">{{ stats.warning }}</div>
        <div style="font-size: 12px; opacity: 0.8;">
            {{ stats.warning_pct }}% of pools - High Priority
        </div>
    </div>

    <!-- Low Space Pools -->
    <div style="background: linear-gradient(135deg, #ffc837 0%, #ff8008 100%); padding: 20px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üü° Low (20-30% Free)</div>
        <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;">{{ stats.low }}</div>
        <div style="font-size: 12px; opacity: 0.8;">
            {{ stats.low_pct }}% of pools - Monitor Closely
        </div>
    </div>

    <!-- OK Pools -->
    <div style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); padding: 20px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üü¢ Healthy (>30% Free)</div>
        <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;">{{ stats.ok }}</div>
        <div style="font-size: 12px; opacity: 0.8;">
            {{ stats.ok_pct }}% of pools - Optimal
        </div>
    </div>

    <!-- Total Capacity -->
    <div style="background: linear-gradient(135deg, #4776e6 0%, #8e54e9 100%); padding: 20px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Capacity</div>
        <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;">{{ stats.total_capacity_tb }} TB</div>
        <div style="font-size: 12px; opacity: 0.8;">
            {{ stats.total_free_tb }} TB free ({{ 100 - stats.avg_utilization }}%)
        </div>
    </div>
</div>

<!-- Overall Health Score -->
<div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h3 style="color: #667eea; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
        üìä Overall Storage Health Score
    </h3>

    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px; align-items: center;">
        <div style="text-align: center;">
            {% set health_score = stats.ok_pct %}
            <div style="font-size: 72px; font-weight: bold; line-height: 1;
                {% if health_score >= 70 %}color: #28a745;
                {% elif health_score >= 50 %}color: #ffc107;
                {% elif health_score >= 30 %}color: #ff6b6b;
                {% else %}color: #dc3545;{% endif %}">
                {{ health_score|round(1) }}%
            </div>
            <div style="color: #666; margin-top: 10px; font-size: 14px;">Pools with >30% Free Space</div>

            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Average Utilization</div>
                <div style="font-size: 24px; font-weight: bold; color:
                    {% if stats.avg_utilization >= 90 %}#dc3545
                    {% elif stats.avg_utilization >= 80 %}#ffc107
                    {% else %}#28a745{% endif %}">
                    {{ stats.avg_utilization }}%
                </div>
            </div>
        </div>

        <div>
            <!-- Visual breakdown -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 600; color: #dc3545;">üî¥ Critical (<10% Free) - URGENT</span>
                    <span style="font-weight: 600;">{{ stats.critical }} ({{ stats.critical_pct }}%)</span>
                </div>
                <div style="background: #f0f0f0; height: 30px; border-radius: 4px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #eb3349 0%, #f45c43 100%); height: 100%; width: {{ stats.critical_pct }}%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                        {% if stats.critical_pct >= 5 %}{{ stats.critical_pct }}%{% endif %}
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 600; color: #f5576c;">üü† Warning (10-20% Free)</span>
                    <span style="font-weight: 600;">{{ stats.warning }} ({{ stats.warning_pct }}%)</span>
                </div>
                <div style="background: #f0f0f0; height: 30px; border-radius: 4px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%); height: 100%; width: {{ stats.warning_pct }}%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                        {% if stats.warning_pct >= 5 %}{{ stats.warning_pct }}%{% endif %}
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 600; color: #ff8008;">üü° Low Space (20-30% Free)</span>
                    <span style="font-weight: 600;">{{ stats.low }} ({{ stats.low_pct }}%)</span>
                </div>
                <div style="background: #f0f0f0; height: 30px; border-radius: 4px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #ffc837 0%, #ff8008 100%); height: 100%; width: {{ stats.low_pct }}%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                        {% if stats.low_pct >= 5 %}{{ stats.low_pct }}%{% endif %}
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 600; color: #28a745;">üü¢ Healthy (>30% Free)</span>
                    <span style="font-weight: 600;">{{ stats.ok }} ({{ stats.ok_pct }}%)</span>
                </div>
                <div style="background: #f0f0f0; height: 30px; border-radius: 4px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #56ab2f 0%, #a8e063 100%); height: 100%; width: {{ stats.ok_pct }}%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                        {% if stats.ok_pct >= 5 %}{{ stats.ok_pct }}%{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Critical Pools Alert -->
{% if critical_pools %}
<div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; border-left: 4px solid #dc3545;">
    <h3 style="color: #dc3545; margin-bottom: 20px;">
        üö® CRITICAL POOLS - Immediate Action Required
        <span style="font-size: 16px; font-weight: normal; color: #666;">({{ critical_pools|length }} pools)</span>
    </h3>

    <div style="background: #fff5f5; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
        <strong style="color: #dc3545;">‚ö†Ô∏è ALERT:</strong> These pools have less than 10% free space.
        Pruning is likely failing or not keeping up with backup rates. Review retention rules and check pruning logs immediately.
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Pool Name</th>
                    <th>MediaAgent</th>
                    <th>Type</th>
                    <th>Total Capacity</th>
                    <th>Free Space</th>
                    <th>% Used</th>
                    <th>% Free</th>
                    <th>Dedup</th>
                </tr>
            </thead>
            <tbody>
                {% for pool in critical_pools %}
                <tr style="background: #fff5f5;">
                    <td><strong style="color: #dc3545;">{{ pool.storagePoolName }}</strong></td>
                    <td>{{ pool.mediaAgentName if pool.mediaAgentName else 'N/A' }}</td>
                    <td>{{ pool.storagePoolType if pool.storagePoolType else 'N/A' }}</td>
                    <td>{{ "%.5f"|format(pool.totalCapacity_tb) }} TB</td>
                    <td style="color: #dc3545; font-weight: bold;">{{ "%.5f"|format(pool.freeSpace_tb) }} TB</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="flex: 1; background: #f0f0f0; height: 20px; border-radius: 3px; overflow: hidden;">
                                <div style="background: #dc3545; height: 100%; width: {{ pool.pct_used }}%;"></div>
                            </div>
                            <span style="font-weight: bold; color: #dc3545;">{{ pool.pct_used }}%</span>
                        </div>
                    </td>
                    <td><strong style="color: #dc3545;">{{ pool.pct_free }}%</strong></td>
                    <td>{{ 'Yes' if pool.is_dedup else 'No' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Warning Pools -->
{% if warning_pools %}
<div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; border-left: 4px solid #ff6b6b;">
    <h3 style="color: #ff6b6b; margin-bottom: 20px;">
        ‚ö†Ô∏è WARNING POOLS - High Priority
        <span style="font-size: 16px; font-weight: normal; color: #666;">({{ warning_pools|length }} pools)</span>
    </h3>

    <div style="background: #fff9f0; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
        <strong style="color: #ff6b6b;">Note:</strong> These pools have 10-20% free space.
        Monitor closely and verify pruning is running successfully. Consider optimizing retention rules.
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Pool Name</th>
                    <th>MediaAgent</th>
                    <th>Type</th>
                    <th>Total Capacity</th>
                    <th>Free Space</th>
                    <th>% Used</th>
                    <th>% Free</th>
                    <th>Dedup</th>
                </tr>
            </thead>
            <tbody>
                {% for pool in warning_pools %}
                <tr style="background: #fffaf0;">
                    <td><strong style="color: #ff6b6b;">{{ pool.storagePoolName }}</strong></td>
                    <td>{{ pool.mediaAgentName if pool.mediaAgentName else 'N/A' }}</td>
                    <td>{{ pool.storagePoolType if pool.storagePoolType else 'N/A' }}</td>
                    <td>{{ "%.5f"|format(pool.totalCapacity_tb) }} TB</td>
                    <td style="color: #ff6b6b; font-weight: bold;">{{ "%.5f"|format(pool.freeSpace_tb) }} TB</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="flex: 1; background: #f0f0f0; height: 20px; border-radius: 3px; overflow: hidden;">
                                <div style="background: #ff6b6b; height: 100%; width: {{ pool.pct_used }}%;"></div>
                            </div>
                            <span style="font-weight: bold; color: #ff6b6b;">{{ pool.pct_used }}%</span>
                        </div>
                    </td>
                    <td><strong style="color: #ff6b6b;">{{ pool.pct_free }}%</strong></td>
                    <td>{{ 'Yes' if pool.is_dedup else 'No' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Top 10 Fullest Pools -->
{% if top_full_pools %}
<div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h3 style="color: #667eea; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
        üìä Top 10 Fullest Storage Pools
    </h3>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Pool Name</th>
                    <th>MediaAgent</th>
                    <th>Type</th>
                    <th>Total (TB)</th>
                    <th>Used (TB)</th>
                    <th>Free (TB)</th>
                    <th>Utilization</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for pool in top_full_pools %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td><strong>{{ pool.storagePoolName }}</strong></td>
                    <td>{{ pool.mediaAgentName if pool.mediaAgentName else 'N/A' }}</td>
                    <td>{{ pool.storagePoolType if pool.storagePoolType else 'N/A' }}</td>
                    <td>{{ "%.5f"|format(pool.totalCapacity_tb) }}</td>
                    <td>{{ "%.5f"|format(pool.usedSpace_tb) }}</td>
                    <td style="{% if pool.pct_free < 10 %}color: #dc3545; font-weight: bold;{% elif pool.pct_free < 20 %}color: #ff6b6b; font-weight: bold;{% endif %}">
                        {{ "%.5f"|format(pool.freeSpace_tb) }}
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="flex: 1; background: #f0f0f0; height: 25px; border-radius: 3px; overflow: hidden;">
                                <div style="background: {% if pool.pct_used >= 90 %}#dc3545{% elif pool.pct_used >= 80 %}#ff6b6b{% elif pool.pct_used >= 70 %}#ffc107{% else %}#28a745{% endif %};
                                           height: 100%; width: {{ pool.pct_used }}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                    {{ pool.pct_used }}%
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if pool.pct_free < 10 %}
                            <span style="background: #dc3545; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">CRITICAL</span>
                        {% elif pool.pct_free < 20 %}
                            <span style="background: #ff6b6b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">WARNING</span>
                        {% elif pool.pct_free < 30 %}
                            <span style="background: #ffc107; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">LOW</span>
                        {% else %}
                            <span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">OK</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Actionable Recommendations -->
<div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h3 style="color: #667eea; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
        üí° Actionable Recommendations
    </h3>

    <div style="display: grid; gap: 15px;">
        {% if stats.critical > 0 %}
        <div style="background: #fff5f5; padding: 15px; border-radius: 6px; border-left: 4px solid #dc3545;">
            <h4 style="color: #dc3545; margin: 0 0 10px 0;">üî¥ URGENT: {{ stats.critical }} Critical Pool{{ 's' if stats.critical != 1 else '' }}</h4>
            <ul style="margin: 0; padding-left: 20px; color: #666;">
                <li>Check pruning logs (SIDBPrune.log) on MediaAgents for these pools</li>
                <li>Verify data aging is enabled for associated plans/storage policies</li>
                <li>Check for failed pruning jobs or pending deletes backlog</li>
                <li>Consider temporary backup restrictions until space is reclaimed</li>
                <li>Review retention rules - reduce cycles to 1 for short-term retention</li>
            </ul>
        </div>
        {% endif %}

        {% if stats.warning > 0 %}
        <div style="background: #fff9f0; padding: 15px; border-radius: 6px; border-left: 4px solid #ff6b6b;">
            <h4 style="color: #ff6b6b; margin: 0 0 10px 0;">üü† High Priority: {{ stats.warning }} Warning Pool{{ 's' if stats.warning != 1 else '' }}</h4>
            <ul style="margin: 0; padding-left: 20px; color: #666;">
                <li>Monitor daily - these pools will become critical soon</li>
                <li>Verify pruning schedules are running successfully</li>
                <li>Check retention rules for inefficiencies (use Retention Health Dashboard)</li>
                <li>Plan capacity expansion if pruning is working correctly</li>
            </ul>
        </div>
        {% endif %}

        <div style="background: #e7f3ff; padding: 15px; border-radius: 6px; border-left: 4px solid #2196F3;">
            <h4 style="color: #1976D2; margin: 0 0 10px 0;">üìã General Best Practices</h4>
            <ul style="margin: 0; padding-left: 20px; color: #666;">
                <li><strong>Non-Dedup Pools:</strong> Pruning happens immediately when jobs age (direct deletion)</li>
                <li><strong>Dedup Pools:</strong> Micropruning runs automatically; check for DDB pending deletes</li>
                <li><strong>Target:</strong> Maintain >30% free space for optimal performance</li>
                <li><strong>Monitoring:</strong> Alert when pools drop below 20% free</li>
                <li><strong>Retention:</strong> Use 1 cycle for short-term (<30 day) retention</li>
            </ul>
        </div>

        <div style="background: #f3e5f5; padding: 15px; border-radius: 6px; border-left: 4px solid #7b1fa2;">
            <h4 style="color: #7b1fa2; margin: 0 0 10px 0;">üîç Troubleshooting Steps</h4>
            <ol style="margin: 0; padding-left: 20px; color: #666;">
                <li>Check <strong>Retention Health Dashboard</strong> for aging/retention issues</li>
                <li>Review MediaAgent logs: <code>SIDBPrune.log</code> and <code>SIDBPhysicalDeletes.log</code></li>
                <li>Query CommServe database for MMDeletedAF table (aged data awaiting pruning)</li>
                <li>For dedup pools: Check DDB pending deletes count (<100K is healthy)</li>
                <li>Verify pruning schedules are enabled and running</li>
                <li>Check for disk I/O bottlenecks on MediaAgents</li>
            </ol>
        </div>
    </div>
</div>

{% endblock %}
